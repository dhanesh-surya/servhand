{% extends "base.html" %}
{% block title %}User Dashboard - ServicesHand{% endblock %}
{% block head %}
<style>
.bookings-section{margin-top:16px}
.bookings-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.booking-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.booking-card{
  position:relative;background:var(--card);border:1px solid rgba(255,255,255,.06);
  border-radius:14px;overflow:hidden;transition:transform .18s ease, box-shadow .25s ease;
  box-shadow:0 2px 10px rgba(0,0,0,.25)
}
.booking-card:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(0,0,0,.35)}
.booking-top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
.ref{font-weight:600;color:#fff;opacity:.9}
.status-badge{padding:6px 10px;border-radius:999px;font-size:.85rem;border:1px solid transparent}
.status-pending{background:rgba(250,204,21,.18);color:#fde68a;border-color:rgba(250,204,21,.35)}
.status-assigned{background:rgba(59,130,246,.18);color:#93c5fd;border-color:rgba(59,130,246,.35)}
.status-completed{background:rgba(16,185,129,.18);color:#86efac;border-color:rgba(16,185,129,.35)}
.status-cancelled{background:rgba(239,68,68,.18);color:#fca5a5;border-color:rgba(239,68,68,.35)}
.booking-body{padding:12px 14px;display:grid;grid-template-columns:1fr;gap:6px}
.label{font-size:.85rem;color:#cbd5e1}
.value{color:#e5e7eb}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:#cbd5e1;font-size:.85rem}
.booking-actions{display:flex;align-items:center;gap:8px;padding:12px 14px;border-top:1px solid rgba(255,255,255,.06)}
.booking-actions .btn{transition:transform .16s ease, box-shadow .2s ease}
.booking-actions .btn:hover{transform:translateY(-1px)}
.reveal-on-scroll{opacity:0;transform:translateY(12px);transition:opacity .45s ease, transform .45s ease}
.reveal-on-scroll.reveal{opacity:1;transform:translateY(0)}
</style>
{% endblock %}
{% block content %}
<div class="container">
<h2>Your Bookings</h2>
<section class="bookings-section">
  <div class="bookings-header">
    <div class="text-secondary">Manage and track your active, completed, and cancelled bookings</div>
  </div>
  <div class="booking-grid">
    {% for b in bookings %}
    <article class="booking-card reveal-on-scroll" aria-label="Booking {{ b.booking_reference_id }}">
      <div class="booking-top">
        <div class="ref">#{{ b.booking_reference_id }}</div>
        <span class="status-badge {% if b.status == 'pending' %}status-pending{% elif b.status == 'assigned' %}status-assigned{% elif b.status == 'completed' %}status-completed{% else %}status-cancelled{% endif %}">
          {{ b.status|title }}
        </span>
      </div>
      <div class="booking-body">
        <div class="label">Service</div>
        <div class="value">{{ b.service_name }}</div>
        <div class="label">Date & Time</div>
        <div class="value">{{ b.booking_datetime|date:"Y-m-d H:i" }}</div>
        <div class="label">Provider</div>
        <div class="value">{{ b.service_provider.name }} • {{ b.service_provider.phone }}</div>
        <div class="label">Categories</div>
        <div class="chips">
          {% for c in b.service_provider.categories.all %}
            <span class="chip">{{ c.category_name }}</span>
          {% empty %}
            <span class="chip">—</span>
          {% endfor %}
        </div>
        <div class="label">Location</div>
        <div class="value">{{ b.service_provider.location }}</div>
        <div class="label">Final Amount</div>
        <div class="value">{{ b.final_amount }}</div>
      </div>
      <div class="booking-actions">
        <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#bookingModal-{{ b.pk }}">View Booking</button>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'provider_detail' b.service_provider.pk %}">View Provider</a>
        <a class="btn btn-sm btn-outline-success" target="_blank" href="https://wa.me/{{ b.service_provider.phone }}?text=Hello%20{{ b.service_provider.name }},%20regarding%20booking%20{{ b.booking_reference_id }}">WhatsApp</a>
        <a class="btn btn-sm btn-outline-info" target="_blank" href="tel:{{ b.service_provider.phone }}">Call</a>
        <a class="btn btn-sm btn-outline-warning" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ b.service_provider.location|urlencode }}">Directions</a>
        <button type="button" class="btn btn-sm btn-outline-light" data-copy="{{ b.booking_reference_id }}">Copy Ref</button>
        <form method="post" action="{% url 'hire_provider' b.service_provider.pk %}" style="display:inline">{% csrf_token %}
          <input type="hidden" name="service_name" value="{{ b.service_name }}">
          <button class="btn btn-sm btn-outline-primary" type="submit">Rebook</button>
        </form>
        {% if b.status != 'completed' and b.status != 'cancelled' %}
        <form method="post" action="{% url 'booking_complete' b.pk %}" style="display:inline">{% csrf_token %}
          <button class="btn btn-sm btn-primary" type="submit">Mark Completed</button>
        </form>
        <form method="post" action="{% url 'booking_cancel' b.pk %}" style="display:inline">{% csrf_token %}
          <button class="btn btn-sm btn-danger" type="submit">Cancel</button>
        </form>
        {% endif %}
      </div>
    </article>
    <div class="modal fade" id="bookingModal-{{ b.pk }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#0b1224;color:#e5e7eb;border:1px solid rgba(255,255,255,.06)">
          <div class="modal-header">
            <h5 class="modal-title">Booking #{{ b.booking_reference_id }}</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div><strong>Status:</strong></div>
              <span class="status-badge {% if b.status == 'pending' %}status-pending{% elif b.status == 'assigned' %}status-assigned{% elif b.status == 'completed' %}status-completed{% else %}status-cancelled{% endif %}">
                {{ b.status|title }}
              </span>
            </div>
            <div class="mb-1"><strong>Service:</strong> {{ b.service_name }}</div>
            <div class="mb-1"><strong>Date & Time:</strong> {{ b.booking_datetime|date:"Y-m-d H:i" }}</div>
            <div class="mb-1"><strong>Provider:</strong> {{ b.service_provider.name }} ({{ b.service_provider.phone }})</div>
            <div class="mb-1"><strong>Location:</strong> {{ b.service_provider.location }}</div>
            <div class="mb-1"><strong>Final Amount:</strong> {{ b.final_amount|default:"—" }}</div>
            <div class="mt-2"><strong>Categories:</strong>
              {% for c in b.service_provider.categories.all %}
                <span class="badge-soft">{{ c.category_name }}</span>
              {% empty %}
                <span class="text-muted">—</span>
              {% endfor %}
            </div>
          </div>
          <div class="modal-footer">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'provider_detail' b.service_provider.pk %}">View Provider</a>
            <a class="btn btn-outline-success btn-sm" target="_blank" href="https://wa.me/{{ b.service_provider.phone }}?text=Hello%20{{ b.service_provider.name }},%20regarding%20booking%20{{ b.booking_reference_id }}">WhatsApp</a>
            <a class="btn btn-outline-info btn-sm" target="_blank" href="tel:{{ b.service_provider.phone }}">Call</a>
            <a class="btn btn-outline-warning btn-sm" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ b.service_provider.location|urlencode }}">Directions</a>
            <a class="btn btn-outline-light btn-sm" target="_blank" href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ b.service_name|urlencode }}&details=Booking%20{{ b.booking_reference_id }}&location={{ b.service_provider.location|urlencode }}&dates={{ b.booking_datetime|date:'Ymd\\THis' }}/{{ b.booking_datetime|date:'Ymd\\THis' }}">Add to Calendar</a>
            <button type="button" class="btn btn-outline-light btn-sm" data-copy="{{ b.booking_reference_id }}">Copy Ref</button>
            <button type="button" class="btn btn-outline-light btn-sm" data-print="bookingModal-{{ b.pk }}">Print</button>
            <form method="post" action="{% url 'hire_provider' b.service_provider.pk %}" style="display:inline">{% csrf_token %}
              <input type="hidden" name="service_name" value="{{ b.service_name }}">
              <button class="btn btn-outline-primary btn-sm" type="submit">Rebook</button>
            </form>
            {% if b.status != 'completed' and b.status != 'cancelled' %}
            <form method="post" action="{% url 'booking_complete' b.pk %}" style="display:inline">{% csrf_token %}
              <button class="btn btn-primary btn-sm" type="submit">Mark Completed</button>
            </form>
            <form method="post" action="{% url 'booking_cancel' b.pk %}" style="display:inline">{% csrf_token %}
              <button class="btn btn-danger btn-sm" type="submit">Cancel</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="booking-card p-3 text-center">No bookings yet.</div>
    {% endfor %}
  </div>
</section>
</div>
<script>
document.addEventListener('click',function(e){
  const t=e.target;
  if(t.dataset.copy){navigator.clipboard?.writeText(t.dataset.copy);}
  if(t.dataset.print){const id=t.dataset.print;const el=document.getElementById(id);const modal=new bootstrap.Modal(el);modal.hide();setTimeout(()=>window.print(),200);}
});
</script>
{% endblock %}
